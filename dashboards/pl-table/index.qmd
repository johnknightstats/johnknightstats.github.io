---
title: "Premier League Table & Metrics"
description: "Points, goals, xG splits, field tilt, shot share."
categories: [football, premier-league]
image: thumb.png
format:
  html:
    toc: false
execute:
  echo: false
  warning: false
  message: false
dashboard_order: 1

---

```{r}
library(readr)
library(dplyr)
library(DT)

df_raw <- read_csv("pl_table_current_season.csv", show_col_types=FALSE)
has_bookie <- "bookie_pts" %in% names(df_raw)


style_grad <- function(x, base_pal, n=101) {
  rng <- range(x, na.rm=TRUE)
  if (!is.finite(rng[1]) || !is.finite(rng[2]) || rng[1] == rng[2]) return(NULL)
  cols <- grDevices::colorRampPalette(base_pal)(n)
  cuts <- seq(rng[1], rng[2], length.out=n)[-1]
  list(cuts=cuts, cols=cols)
}

pal_g2r <- c("#1a9850","#66bd63","#a6d96a","#d9ef8b","#fee08b","#fdae61","#d73027")
pal_r2g <- rev(pal_g2r)

df <- df_raw |>
  select(-team_id, -games_won, -games_drawn, -games_lost) |>
  mutate(
    field_tilt = as.numeric(field_tilt),
    shot_share = as.numeric(shot_share)
  ) |>
    rename(
    Team = team_name,
    P = games_played,
    Pts = points,
    GF = goals_for,
    GA = goals_against,
    GD = goal_difference,
    xG = xg_for,
    xGA = xg_against,
    xGD = xg_diff,
    `xGD (open-play)` = xg_open_play_diff,
    `xGD (set-piece)` = xg_set_play_diff,
    `xGD (non-pen)` = xg_non_penalty_diff,
    `Field Tilt` = field_tilt,
    `Shot Share` = shot_share
  )

if (has_bookie) {
  df <- df |> rename(`Bookie Pts` = bookie_pts)
}



g2r_cols_reversed <- c(
  "Pts","Bookie Pts","GF","GD","xG","xGD",
  "xGD (open-play)","xGD (set-piece)","xGD (non-pen)",
  "Field Tilt","Shot Share"
)

r2g_cols_reversed <- c("GA","xGA")
g2r_cols_reversed <- intersect(g2r_cols_reversed, names(df))
r2g_cols_reversed <- intersect(r2g_cols_reversed, names(df))


dt <- datatable(
  df,
  rownames = FALSE,
  extensions = "FixedColumns",
  options = list(
    dom = "t",
    paging = FALSE,
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 1),
    autoWidth = FALSE,

    # Smaller header font
    headerCallback = JS(
      "function(thead) {",
      "  $(thead).find('th').css({",
      "    'font-size': '11px',",
      "    'padding': '4px 6px'",
      "  });",
      "}"
    ),

    columnDefs = list(
      list(width = "210px", targets = 0),
      list(className = "dt-nowrap", targets = 0),

      # Right-align all numeric columns (everything except Team)
      list(className = "dt-right", targets = 1:(ncol(df) - 1))
    )

  )
)

round_cols <- intersect(
  c("Bookie Pts","xG","xGA","xGD",
    "xGD (open-play)","xGD (set-piece)","xGD (non-pen)"),
  names(df)
)

if (length(round_cols) > 0) {
  dt <- dt |> formatRound(round_cols, digits = 1)
}

dt <- dt |>
  formatPercentage(c("Field Tilt","Shot Share"), digits = 1) |>
  formatStyle(names(df), fontSize = "12px", padding = "2px 6px") |>
  formatStyle("Team", whiteSpace = "nowrap")


for (col in g2r_cols_reversed) {
  s <- style_grad(df[[col]], pal_r2g)
  if (!is.null(s)) dt <- dt |> formatStyle(col, backgroundColor = styleInterval(s$cuts, s$cols))
}
for (col in r2g_cols_reversed) {
  s <- style_grad(df[[col]], pal_g2r)
  if (!is.null(s)) dt <- dt |> formatStyle(col, backgroundColor = styleInterval(s$cuts, s$cols))
}

dt

```

<div style="font-size: 0.85em; line-height: 1.25;">

### Notes
- **Bookie Pts** = Expected number of points based on Pinnacle closing match odds throughout the season.
- **xG** = Expected Goals (all, non-penalty, open-play, or set-pieces).
- **Field Tilt** = Share of touches inside opposition's penalty box.
- **Shot Share** = Share of total shots.

</div>
