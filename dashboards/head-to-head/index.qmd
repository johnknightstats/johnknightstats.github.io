---
title: "Head-to-head: shared Football League seasons"
format:
  html:
    toc: false
    page-layout: full
runtime: shiny
execute:
  echo: false
  warning: false
  message: false
draft: true
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(shiny)
library(DBI)
library(RSQLite)
library(dplyr)
library(stringr)
library(readr)
library(plotly)
library(tidyr)
library(htmltools)
library(jsonlite)


# --- Path to your sqlite DB ---
DB_PATH <- file.path("data", "englishfootball.db")

con <- dbConnect(RSQLite::SQLite(), DB_PATH)
invisible(onStop(function() dbDisconnect(con)))

# ---- CSS to make the app fill the screen (less scrolling) ----
app_css <- "
html, body { height: 100%; }
.container-fluid { max-width: 1400px; }
"

# ---- Team menu CSV (your curated list + badge paths) ----
# Expected columns: team_id, team_name, badge
# badge should be a path under www/, e.g. badges/aston_villa.png
TEAMS_MENU_CSV <- file.path("data", "teams_menu.csv")

teams_menu <- read_csv(TEAMS_MENU_CSV, show_col_types = FALSE) %>%
  mutate(team_id = as.character(team_id)) %>%
  select(team_id, team_name, badge)

team_choices <- setNames(teams_menu$team_name, teams_menu$team_id)


# a named character vector: names are team_id, values are badge paths
badge_map <- setNames(teams_menu$badge, teams_menu$team_id)

stopifnot(all(c("team_id", "team_name", "badge") %in% names(teams_menu)))

# ---- Team colours CSV ----
# Expected columns: team_id, home_colour, change_colour
COLOURS_CSV <- file.path("data", "team_colours.csv")

team_colours <- read_csv(COLOURS_CSV, show_col_types = FALSE) %>%
  mutate(team_id = as.character(team_id)) %>%
  select(team_id, home_colour, change_colour)

stopifnot(all(c("team_id", "home_colour", "change_colour") %in% names(team_colours)))

# ---- Default colour generator (deterministic fallback) ----
default_colour <- function(team_id, variant = c("home", "change")) {
  variant <- match.arg(variant)

  base_pal <- c(
    "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728",
    "#9467bd", "#8c564b", "#e377c2", "#7f7f7f",
    "#bcbd22", "#17becf"
  )

  id_num <- suppressWarnings(as.integer(gsub("[^0-9]", "", team_id)))
  if (is.na(id_num)) id_num <- sum(utf8ToInt(team_id))

  idx <- (id_num %% length(base_pal)) + 1
  col <- base_pal[idx]

  if (variant == "change") col <- grDevices::adjustcolor(col, alpha.f = 0.6)
  col
}

# ---- Helpers to parse season_id like: S-1925-3-N ----
parse_season_id <- function(season_id) {
  m <- str_match(season_id, "^S-([0-9]{4})-([0-9]+)(?:-([NS]))?$")
  tibble(
    season_id = season_id,
    year = as.integer(m[,2]),
    tier = as.integer(m[,3]),
    region = m[,4]  # NA, "N", or "S"
  )
}

season_label <- function(year, tier, region) {
  y2 <- year + 1
  div <- paste0("Tier ", tier)
  if (!is.na(region) && region %in% c("N", "S")) div <- paste(div, paste0("(", region, ")"))
  paste0(year, "–", substr(y2, 3, 4), " · ", div)
}

decide_winner_one_year <- function(a_row, b_row, a_name, b_name) {
  a_in <- nrow(a_row) == 1
  b_in <- nrow(b_row) == 1

  if (!a_in || !b_in) {
    return(list(result = "—", note = "At least one team not in Football League"))
  }

  if (a_row$tier[1] < b_row$tier[1]) return(list(result = a_name, note = "Higher division"))
  if (a_row$tier[1] > b_row$tier[1]) return(list(result = b_name, note = "Higher division"))

  tier <- a_row$tier[1]
  if (tier == 3) {
    ra <- a_row$region[1]
    rb <- b_row$region[1]
    if (!is.na(ra) && !is.na(rb) && ra != rb) {
      return(list(result = "—", note = "Tier 3 split (N vs S)"))
    }
  }

  if (a_row$position[1] < b_row$position[1]) return(list(result = a_name, note = "Higher position"))
  if (a_row$position[1] > b_row$position[1]) return(list(result = b_name, note = "Higher position"))

  list(result = "—", note = "Same tier & position")
}

# ---- Selectize option renderer with badges ----
# Uses <img> in the dropdown (works well with selectize)
selectize_with_badges_opts <- function(badge_map) {
  # Convert named vector to JSON object string
  badge_json <- jsonlite::toJSON(as.list(badge_map), auto_unbox = TRUE)

  selectizeOptions(
    render = I(paste0("
      {
        option: function(item, escape) {
          var badges = ", badge_json, ";
          var badge = badges[item.value] || '';
          var name = escape(item.text);
          if (badge) {
            return '<div style=\"display:flex; align-items:center; gap:10px;\">' +
                   '<img src=\"' + badge + '\" style=\"height:20px; width:20px; object-fit:contain;\" />' +
                   '<span>' + name + '</span></div>';
          } else {
            return '<div>' + name + '</div>';
          }
        },
        item: function(item, escape) {
          var badges = ", badge_json, ";
          var badge = badges[item.value] || '';
          var name = escape(item.text);
          if (badge) {
            return '<div style=\"display:flex; align-items:center; gap:8px;\">' +
                   '<img src=\"' + badge + '\" style=\"height:18px; width:18px; object-fit:contain;\" />' +
                   '<span>' + name + '</span></div>';
          } else {
            return '<div>' + name + '</div>';
          }
        }
      }
    ")),
    placeholder = "Select a team...",
    maxOptions = 500
  )
}


# ---- UI ----
ui <- fluidPage(
  tags$head(tags$style(HTML(app_css))),
  fluidRow(
    column(
      6,
      selectizeInput("team_a", "Team A", choices = NULL, selected = NULL, options = list())
    ),
    column(
      6,
      selectizeInput("team_b", "Team B", choices = NULL, selected = NULL, options = list())
    )
  ),
  hr(),
  plotlyOutput("h2h_plot", height = "520px"),
  tags$small("Hover points for details. Each year shows both teams on separate lines; a diamond outlines the team that finished higher."),
  br(),
  verbatimTextOutput("clicked_details")
)

# ---- Server ----
server <- function(input, output, session) {

  # Initialize selectize choices from teams_menu (your curated file)
  observeEvent(TRUE, {
  a0 <- teams_menu$team_id[1]
  b0 <- teams_menu$team_id[min(2, nrow(teams_menu))]

  updateSelectizeInput(
    session, "team_a",
    choices = team_choices,
    selected = a0,
    # options = selectize_with_badges_opts(badge_map)
  )

  updateSelectizeInput(
    session, "team_b",
    choices = team_choices,
    selected = b0,
    # options = selectize_with_badges_opts(badge_map)
  )
}, once = TRUE)


  # Prevent selecting the same team in both inputs
  observeEvent(input$team_a, {
  req(input$team_a)

  team_choices_b <- team_choices[names(team_choices) != input$team_a]
  
  # preserve b if still valid, else pick first available
  b_sel <- input$team_b
  if (is.null(b_sel) || !(b_sel %in% team_choices_b)) b_sel <- unname(team_choices_b[1])

  updateSelectizeInput(
    session, "team_b",
    choices = team_choices_b,
    selected = b_sel,
    # options = selectize_with_badges_opts(badge_map)
  )
}, ignoreInit = TRUE)

observeEvent(input$team_b, {
  req(input$team_b)

  team_choices_a <- team_choices[names(team_choices) != input$team_b]


  a_sel <- input$team_a
  if (is.null(a_sel) || !(a_sel %in% team_choices_a)) a_sel <- unname(team_choices_a[1])

  updateSelectizeInput(
    session, "team_a",
    choices = team_choices_a,
    selected = a_sel,
    # options = selectize_with_badges_opts(badge_map)
  )
}, ignoreInit = TRUE)


  standings_ab <- reactive({
    req(input$team_a, input$team_b)

    st <- dbGetQuery(con, "
      SELECT season_id, team_id, position, played, wins, draws, losses,
             goals_for, goals_against, goal_difference, points, point_adjustment
      FROM standings
      WHERE team_id IN (?, ?)
    ", params = list(input$team_a, input$team_b))

    st <- as_tibble(st) %>%
      mutate(team_id = as.character(team_id), season_id = as.character(season_id))

    parsed <- parse_season_id(st$season_id)

    st %>% left_join(parsed, by = "season_id")
  })

  year_summary <- reactive({
    st <- standings_ab()

    a_id <- as.character(input$team_a)
    b_id <- as.character(input$team_b)

    a_name <- teams_menu$team_name[match(a_id, teams_menu$team_id)]
    b_name <- teams_menu$team_name[match(b_id, teams_menu$team_id)]

    best_for_team_year <- function(df, tid, y) {
      df %>%
        filter(team_id == tid, year == y) %>%
        arrange(tier, position) %>%
        slice(1)
    }

    yr_min <- min(st$year, na.rm = TRUE)
    yr_max <- max(st$year, na.rm = TRUE)
    all_years <- seq(yr_min, yr_max)

    rows <- lapply(all_years, function(y) {
      a_row <- best_for_team_year(st, a_id, y)
      b_row <- best_for_team_year(st, b_id, y)

      a_in <- nrow(a_row) == 1
      b_in <- nrow(b_row) == 1

      dec <- decide_winner_one_year(a_row, b_row, a_name, b_name)

      tibble(
        year = y,

        a_in = a_in,
        a_season = if (a_in) season_label(a_row$year[1], a_row$tier[1], a_row$region[1]) else NA_character_,
        a_pos = if (a_in) a_row$position[1] else NA_integer_,
        a_pts = if (a_in) a_row$points[1] else NA_integer_,
        a_gd  = if (a_in) a_row$goal_difference[1] else NA_integer_,
        a_wdl = if (a_in) paste0(a_row$wins[1], "-", a_row$draws[1], "-", a_row$losses[1]) else NA_character_,

        b_in = b_in,
        b_season = if (b_in) season_label(b_row$year[1], b_row$tier[1], b_row$region[1]) else NA_character_,
        b_pos = if (b_in) b_row$position[1] else NA_integer_,
        b_pts = if (b_in) b_row$points[1] else NA_integer_,
        b_gd  = if (b_in) b_row$goal_difference[1] else NA_integer_,
        b_wdl = if (b_in) paste0(b_row$wins[1], "-", b_row$draws[1], "-", b_row$losses[1]) else NA_character_,

        finished_highest = dec$result,
        reason = dec$note,

        a_name = a_name,
        b_name = b_name,

        a_id = a_id,
        b_id = b_id
      )
    })

    bind_rows(rows)
  })

  output$h2h_plot <- renderPlotly({
    df <- year_summary()

    a_id <- df$a_id[1]
    b_id <- df$b_id[1]
    a_name <- df$a_name[1]
    b_name <- df$b_name[1]

    # badges (paths under www/)
    a_badge <- teams_menu$badge[match(a_id, teams_menu$team_id)]
    b_badge <- teams_menu$badge[match(b_id, teams_menu$team_id)]

    # Colours from CSV (fallback to deterministic)
    a_col <- team_colours %>% filter(team_id == a_id) %>% slice(1)
    b_col <- team_colours %>% filter(team_id == b_id) %>% slice(1)

    col_a_home   <- if (nrow(a_col) == 1) a_col$home_colour[1]   else default_colour(a_id, "home")
    col_a_change <- if (nrow(a_col) == 1) a_col$change_colour[1] else default_colour(a_id, "change")

    col_b_home   <- if (nrow(b_col) == 1) b_col$home_colour[1]   else default_colour(b_id, "home")
    col_b_change <- if (nrow(b_col) == 1) b_col$change_colour[1] else default_colour(b_id, "change")

    # clash rule (outline / accents)
    col_a <- col_a_home
    col_b <- if (tolower(col_b_home) == tolower(col_a_home)) col_b_change else col_b_home

    # Build plotting data: only shared seasons
    df_plot <- df %>%
      mutate(
        both_in = a_in & b_in,
        hover = paste0(
          "<b>Year: </b>", year, "<br>",
          "<br><b>", a_name, "</b><br>",
          if_else(both_in, paste0(a_season, "<br>Pos: ", a_pos, " · Pts: ", a_pts, "<br>W-D-L: ", a_wdl, " · GD: ", a_gd), "Not in league"),
          "<br><br><b>", b_name, "</b><br>",
          if_else(both_in, paste0(b_season, "<br>Pos: ", b_pos, " · Pts: ", b_pts, "<br>W-D-L: ", b_wdl, " · GD: ", b_gd), "Not in league"),
          "<br><br><b>Finished higher:</b> ", finished_highest,
          "<br><b>Reason:</b> ", reason
        )
      ) %>%
      filter(both_in)

    # Two lanes: A at y=1, B at y=0
    df_a <- df_plot %>% mutate(team = "A", y = 1, badge = a_badge)
    df_b <- df_plot %>% mutate(team = "B", y = 0, badge = b_badge)
    
    # Convert badge paths to served URLs
    a_badge_src <- if (!is.na(a_badge) && nzchar(a_badge)) paste0("/", a_badge) else NULL
    b_badge_src <- if (!is.na(b_badge) && nzchar(b_badge)) paste0("/", b_badge) else NULL
    
    # Helper to build plotly layout image objects
    make_badge_images <- function(df_lane, src) {
      if (is.null(src) || nrow(df_lane) == 0) return(list())
    
      lapply(seq_len(nrow(df_lane)), function(i) {
        list(
          source = src,
          xref = "x",
          yref = "y",
          x = df_lane$year[i],
          y = df_lane$y[i],
          sizex = 2.2,   # badge width in "x units" (years)
          sizey = 0.22,  # badge height in "y units"
          xanchor = "center",
          yanchor = "middle",
          sizing = "contain",
          opacity = 1,
          layer = "above"
        )
      })
    }
    
    imgs_a <- make_badge_images(df_a, a_badge_src)
    imgs_b <- make_badge_images(df_b, b_badge_src)
    all_imgs <- c(imgs_a, imgs_b)


    # Winner markers (diamond outline) over the winning team's lane
    df_win_a <- df_plot %>% filter(finished_highest == a_name) %>% mutate(y = 1)
    df_win_b <- df_plot %>% filter(finished_highest == b_name) %>% mutate(y = 0)
    df_tie   <- df_plot %>% filter(finished_highest == "—") %>% mutate(y = 0.5)

    p <- plot_ly() %>%
      # Invisible hover/click points for Team A lane
      add_trace(
        data = df_a,
        x = ~year, y = ~y,
        type = "scatter", mode = "markers",
        name = a_name,
        text = ~hover, hoverinfo = "text",
        marker = list(size = 20, opacity = 0),
        customdata = ~year,
        showlegend = FALSE
      ) %>%
      # Invisible hover/click points for Team B lane
      add_trace(
        data = df_b,
        x = ~year, y = ~y,
        type = "scatter", mode = "markers",
        name = b_name,
        text = ~hover, hoverinfo = "text",
        marker = list(size = 20, opacity = 0),
        customdata = ~year,
        showlegend = FALSE
      ) %>%
      # Winner overlays (diamond outlines)
      add_trace(
        data = df_win_a,
        x = ~year, y = ~y,
        type = "scatter", mode = "markers",
        name = paste0(a_name, " finished higher"),
        text = ~hover, hoverinfo = "text",
        marker = list(
          size = 34,
          symbol = "diamond",
          color = "rgba(0,0,0,0)",
          line = list(width = 3, color = col_a)
        ),
        customdata = ~year,
        showlegend = TRUE
      ) %>%
      add_trace(
        data = df_win_b,
        x = ~year, y = ~y,
        type = "scatter", mode = "markers",
        name = paste0(b_name, " finished higher"),
        text = ~hover, hoverinfo = "text",
        marker = list(
          size = 34,
          symbol = "diamond",
          color = "rgba(0,0,0,0)",
          line = list(width = 3, color = col_b)
        ),
        customdata = ~year,
        showlegend = TRUE
      ) %>%
      # Tie marker in the middle
      add_trace(
        data = df_tie,
        x = ~year, y = ~y,
        type = "scatter", mode = "markers",
        name = "Tie / unclear (e.g., Tier 3 N vs S)",
        text = ~hover, hoverinfo = "text",
        marker = list(
          size = 16,
          symbol = "square",
          color = "gray70",
          line = list(width = 1, color = "gray40")
        ),
        customdata = ~year,
        showlegend = TRUE
      ) %>%
      layout(
        xaxis = list(title = "", tickmode = "linear", dtick = 5, zeroline = FALSE),
        yaxis = list(
          title = "",
          tickmode = "array",
          tickvals = c(1, 0),
          ticktext = c(a_name, b_name),
          range = c(-0.6, 1.6),
          zeroline = FALSE
        ),
        legend = list(orientation = "h", x = 0, y = -0.25),
        margin = list(l = 70, r = 20, t = 10, b = 90)
      )

    p <- p %>% layout(images = all_imgs)
    p

  })

  # Click-to-pin details
  output$clicked_details <- renderPrint({
    click <- event_data("plotly_click")
    if (is.null(click)) {
      cat("Click a point to pin its details here.")
      return()
    }
    y <- click$customdata
    df <- year_summary()
    row <- df %>% filter(year == y) %>% slice(1)

    cat(paste0(
      "Year: ", row$year, "\n",
      "Finished higher: ", row$finished_highest, "\n",
      "Reason: ", row$reason, "\n\n",
      row$a_name, ": ", if (!is.na(row$a_season)) paste0(row$a_season, " | Pos ", row$a_pos, " | Pts ", row$a_pts, " | WDL ", row$a_wdl, " | GD ", row$a_gd) else "Not in Football League", "\n",
      row$b_name, ": ", if (!is.na(row$b_season)) paste0(row$b_season, " | Pos ", row$b_pos, " | Pts ", row$b_pts, " | WDL ", row$b_wdl, " | GD ", row$b_gd) else "Not in Football League", "\n"
    ))
  })
}

shinyApp(ui, server)

```



