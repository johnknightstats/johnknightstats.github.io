---
title: "Head-to-head: shared Football League seasons"
format:
  html:
    toc: false
    page-layout: full
runtime: shiny
execute:
  echo: false
  warning: false
  message: false
draft: true


---

```{r, echo=FALSE, warning=FALSE, message=FALSE}


library(shiny)
library(DBI)
library(RSQLite)
library(dplyr)
library(stringr)
library(DT)

# --- Path to your sqlite DB ---

DB_PATH <- file.path("data", "englishfootball.db")

con <- dbConnect(RSQLite::SQLite(), DB_PATH)
onStop(function() dbDisconnect(con))

# ---- Load teams for dropdowns ----

teams <- dbGetQuery(con, "
SELECT team_id, team_name
FROM teams
ORDER BY team_name
")

team_choices <- setNames(teams$team_id, teams$team_name)

# ---- Helpers to parse season_id like: S-1925-3-N ----

parse_season_id <- function(season_id) {
m <- str_match(season_id, "^S-([0-9]{4})-([0-9]+)(?:-([NS]))?$")
tibble(
season_id = season_id,
year = as.integer(m[,2]),
tier = as.integer(m[,3]),
region = m[,4]  # NA, "N", or "S"
)
}

year_label <- function(y) as.character(y)

decide_winner_one_year <- function(a_row, b_row, a_name, b_name) {
a_in <- nrow(a_row) == 1
b_in <- nrow(b_row) == 1

# If either is not in the Football League that year: tie

if (!a_in || !b_in) {
return(list(result = "—", note = "At least one team not in Football League"))
}

# Compare tiers (lower number is higher division)

if (a_row$tier[1] < b_row$tier[1]) return(list(result = a_name, note = "Higher division"))
if (a_row$tier[1] > b_row$tier[1]) return(list(result = b_name, note = "Higher division"))

# Same tier

tier <- a_row$tier[1]

# Special: if tier 3 and one is N and the other is S => tie

if (tier == 3) {
ra <- a_row$region[1]
rb <- b_row$region[1]
if (!is.na(ra) && !is.na(rb) && ra != rb) {
return(list(result = "—", note = "Tier 3 split (N vs S)"))
}
}

# Same tier: compare position (lower is better)

if (a_row$position[1] < b_row$position[1]) return(list(result = a_name, note = "Higher position"))
if (a_row$position[1] > b_row$position[1]) return(list(result = b_name, note = "Higher position"))

list(result = "—", note = "Same tier & position")
}

# ---- UI ----

ui <- fluidPage(
fluidRow(
column(
6,
selectInput("team_a", "Team A", choices = team_choices, selected = teams$team_id[1])
),
column(
6,
selectInput("team_b", "Team B", choices = team_choices, selected = teams$team_id[min(2, nrow(teams))])
)
),
hr(),
DTOutput("result_tbl"),
br(),
tags$small("Notes: Division (tier) outranks position. Tier 3 North vs South counts as a tie regardless of position. If either team is not in the Football League that year, it’s a tie.")
)

# ---- Server ----

server <- function(input, output, session) {

standings_ab <- reactive({
req(input$team_a, input$team_b)

st <- dbGetQuery(con, "
  SELECT season_id, team_id, position, played, wins, draws, losses,
         goals_for, goals_against, goal_difference, points, point_adjustment
  FROM standings
  WHERE team_id IN (?, ?)
", params = list(input$team_a, input$team_b))

st <- as_tibble(st) %>%
  mutate(
    team_id = as.character(team_id),
    season_id = as.character(season_id)
  )

parsed <- parse_season_id(st$season_id)

st %>%
  left_join(parsed, by = "season_id")

})

output$result_tbl <- renderDT({
st <- standings_ab()

a_id <- as.character(input$team_a)
b_id <- as.character(input$team_b)

a_name <- teams$team_name[match(a_id, teams$team_id)]
b_name <- teams$team_name[match(b_id, teams$team_id)]

years <- sort(unique(st$year))

best_for_team_year <- function(df, tid, y) {
  df %>%
    filter(team_id == tid, year == y) %>%
    arrange(tier, position) %>%
    slice(1)
}

rows <- lapply(years, function(y) {
  a_row <- best_for_team_year(st, a_id, y)
  b_row <- best_for_team_year(st, b_id, y)

  dec <- decide_winner_one_year(a_row, b_row, a_name, b_name)

  tibble(
    season_year = year_label(y),
    team_a_div = if (nrow(a_row) == 1) a_row$season_id[1] else NA_character_,
    team_a_pos = if (nrow(a_row) == 1) a_row$position[1] else NA_integer_,
    team_b_div = if (nrow(b_row) == 1) b_row$season_id[1] else NA_character_,
    team_b_pos = if (nrow(b_row) == 1) b_row$position[1] else NA_integer_,
    finished_highest = dec$result,
    reason = dec$note
  )
})

out <- bind_rows(rows)

datatable(
  out,
  rownames = FALSE,
  options = list(
    dom = "t",
    paging = FALSE,
    scrollX = TRUE
  )
) %>%
  formatStyle(
    "finished_highest",
    target = "cell",
    color = styleEqual("—", "gray")
  )

})
}

shinyApp(ui, server)

```


